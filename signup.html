<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Student Sign Up</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <button class="back-btn" onclick="window.location.href='index.html'">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h2>Student Registration</h2>
        </div>
        <p class="subtitle">Create your student account</p>

        <form id="signupForm">
            <h3>Personal Information</h3>
            
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" name="firstName" required placeholder="Enter your first name" />

            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" name="lastName" required placeholder="Enter your last name" />

            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" required placeholder="student@example.com" />

            <label for="studentNumber">Student Number</label>
            <input type="text" id="studentNumber" name="studentNumber" required placeholder="e.g., ST12345678" />

            <label for="phoneNumber">Phone Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+27 71 234 5678" />

            <h3>Academic Information</h3>

            <label for="course">Course/Program</label>
            <input type="text" id="course" name="course" required placeholder="e.g., Computer Science" />

            <label for="yearOfStudy">Year of Study</label>
            <select id="yearOfStudy" name="yearOfStudy" required>
                <option value="">Select Year</option>
                <option value="1">1st Year</option>
                <option value="2">2nd Year</option>
                <option value="3">3rd Year</option>
                <option value="4">4th Year</option>
                <option value="5">5th Year+</option>
            </select>

            <h3>Account Security</h3>

            <label for="password">Password</label>
            <input type="password" id="password" name="password" required minlength="6" placeholder="At least 6 characters" />

            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Re-enter password" />

            <div style="margin: 15px 0;">
                <input type="checkbox" id="terms" required />
                <label for="terms" style="display: inline; font-weight: normal;">
                    I agree to the residence hall terms and conditions
                </label>
            </div>

            <button type="submit" class="btn">Sign Up</button>
        </form>

        <p>Already have an account? <a href="login.html">Login</a></p>
        <img class="Housebackground" src="img/house.jpeg" alt="House Image" />
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="api-config.js"></script>

    <script>
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('Form submitted');

            // Get form values
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                email: document.getElementById('email').value.trim(),
                studentNumber: document.getElementById('studentNumber').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                course: document.getElementById('course').value.trim(),
                yearOfStudy: document.getElementById('yearOfStudy').value,
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value
            };

            console.log('Form data collected:', {
                ...formData,
                password: '***',
                confirmPassword: '***'
            });

            // Validate all fields are filled
            for (const [key, value] of Object.entries(formData)) {
                if (key !== 'confirmPassword' && (!value || value === '')) {
                    alert(`Please fill in the ${key} field`);
                    return;
                }
            }

            // Validate passwords match
            if (formData.password !== formData.confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            if (formData.password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;

            try {
                // Prepare signup data (without confirmPassword)
                const signupData = {
                    email: formData.email,
                    password: formData.password,
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    studentNumber: formData.studentNumber,
                    phoneNumber: formData.phoneNumber,
                    course: formData.course,
                    yearOfStudy: parseInt(formData.yearOfStudy)
                };

                console.log('Sending to backend:', {
                    ...signupData,
                    password: formData.password.length + ' chars',
                    passwordExists: !!signupData.password
                });

                const response = await fetch(API_ENDPOINTS.STUDENT.SIGNUP, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(signupData)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (!response.ok) {
                    throw new Error(result.error || result.message || 'Registration failed');
                }

                // Success!
                alert('Account created successfully! Please wait for admin approval. You will receive an email once your account is approved.');
                
                // Redirect to login
                window.location.href = 'login.html';

            } catch (error) {
                console.error('Signup error:', error);
                
                let errorMessage = 'Registration failed: ';
                
                if (error.message.includes('email is already registered') || 
                    error.message.includes('email already exists')) {
                    errorMessage = 'This email is already registered. Please login instead.';
                } else if (error.message.includes('student number')) {
                    errorMessage = 'This student number is already registered.';
                } else if (error.message.includes('Forbidden')) {
                    errorMessage = 'Access denied. Please try again or contact support.';
                } else {
                    errorMessage += error.message;
                }

                alert(errorMessage);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>